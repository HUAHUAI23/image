# 图片生成选项功能说明

## 📋 功能概述

新版本支持更灵活的图片生成配置，包括：
- ✅ 自定义图片尺寸
- ✅ 组图模式（AI 智能生成关联图片）
- ✅ 提示词优化选项
- ✅ 水印控制
- ✅ 智能预付费和退款机制

---

## 🎨 支持的生成选项

### 1. 图片尺寸 (size)

#### 智能尺寸模式
- `1K` - 低分辨率，快速生成
- `2K` - 标准分辨率（默认）
- `4K` - 高分辨率，细节丰富

> AI 会根据提示词中的描述（如"横版海报"、"手机壁纸"）自动选择合适的宽高比。

#### 固定尺寸模式
指定具体的宽×高像素值：
- `2048x2048` - 正方形 (1:1)
- `2560x1440` - 横屏 (16:9)
- `1440x2560` - 竖屏 (9:16)
- `2304x1728` - 标准横版 (4:3)
- `1728x2304` - 标准竖版 (3:4)

**限制**：
- 宽度范围：1280 - 4096 px
- 高度范围：720 - 4096 px

---

### 2. 组图模式 (sequentialImageGeneration)

#### 关闭模式 `disabled`（默认）
- 每批固定生成 **1 张**图片
- 批次数量 = 最终图片数量
- 计费透明，按实际数量收费

**示例**：
```
批次数量: 10 批
预期生成: 10 张
预付费: 10 × 单价
```

#### 开启模式 `auto`
- AI 根据提示词智能判断每批生成的图片数量
- 每批可能生成 **1-15 张**关联图片
- 预付费按最大值计算，实际生成后自动退款

**示例**：
```
批次数量: 5 批
每批最多: 8 张
预期生成: 5 × 8 = 40 张
预付费: 40 × 单价

实际生成: 假设每批生成 [5, 6, 4, 7, 5] = 27 张
退款: (40 - 27) × 单价 = 13 × 单价
```

#### 组图选项 (sequentialImageGenerationOptions)

**maxImages** (可选，默认 15)
- 限制每批最多生成的图片数量
- 范围：1 - 15 张
- 未设置时，AI 完全自主决定（最多 15 张）

**使用场景**：
- ✅ 产品多角度展示（正面、背面、侧面、细节）
- ✅ 故事板生成（起承转合的连续画面）
- ✅ 设计方案对比（不同配色/风格的变体）
- ✅ 场景分解（全景、中景、特写）

---

### 3. 提示词优化 (optimizePromptOptions)

#### 模式选择
- `standard` - 标准模式（默认）
  - 生成质量更高
  - 耗时较长（+2-5秒）
  - 适合重要场景

- `fast` - 快速模式
  - 生成速度更快
  - 质量一般
  - 适合批量测试

---

### 4. 水印控制 (watermark)

- `false` - 不添加水印（默认）
- `true` - 在图片右下角添加"AI生成"水印

> 根据用户等级或会员状态，可以灵活控制是否显示水印。

---

## 💰 计费规则说明

### 传统模式（组图关闭）
```
预付费 = 批次数量 × 单价
退款 = 生成失败的图片数量 × 单价
```

**示例**：
- 请求：100 张
- 单价：10 点/张
- 预付费：1000 点
- 实际生成：95 张成功，5 张失败
- 退款：50 点
- 最终消耗：950 点

---

### 组图模式（组图开启）

#### 预付费计算
```
预期图片数 = 批次数量 × 每批最多生成数量
预付费 = 预期图片数 × 单价
```

#### 退款计算
```
退款 = (预期图片数 - 实际生成数) × 单价
```

**示例 1：设置了 maxImages**
- 批次数量：10 批
- 每批最多：8 张
- 预期图片数：10 × 8 = 80 张
- 单价：10 点/张
- 预付费：800 点
- 实际生成：45 张（AI 决定）
- 退款：(80 - 45) × 10 = 350 点
- 最终消耗：450 点

**示例 2：未设置 maxImages（AI 完全自主）**
- 批次数量：10 批
- 每批最多：15 张（默认最大值）
- 预期图片数：10 × 15 = 150 张
- 单价：10 点/张
- 预付费：1500 点
- 实际生成：68 张
- 退款：(150 - 68) × 10 = 820 点
- 最终消耗：680 点

---

## 🎯 最佳实践

### 1. 选择合适的尺寸
- 社交媒体：`2048x2048` (1:1)
- 网页横幅：`2560x1440` (16:9)
- 手机壁纸：`1440x2560` (9:16)
- 海报设计：使用智能尺寸 `2K` 或 `4K`

### 2. 组图模式使用建议
- ✅ 需要关联内容时开启（如产品系列、故事板）
- ✅ 设置合理的 `maxImages` 避免过度预付费
- ❌ 单纯想要大量独立图片时不要使用
- ❌ 预算有限时谨慎使用（预付费可能较高）

### 3. 优化性能
- 测试阶段使用 `fast` 模式快速迭代
- 正式生产使用 `standard` 模式保证质量
- 大批量任务建议关闭组图模式，使用传统批次生成

### 4. 成本控制
- 组图模式下，设置较小的 `maxImages`（如 3-5 张）
- 先用小批次测试效果，再大规模生成
- 关注实际生成数量和退款金额

---

## 🔧 技术实现

### 数据库字段
```sql
-- 生成选项配置
generation_options JSONB NOT NULL DEFAULT '{}'

-- 预期生成数量（预付费计算）
expected_image_count INTEGER NOT NULL

-- 实际生成数量（退款计算）
actual_image_count INTEGER NOT NULL DEFAULT 0
```

### API 参数结构
```typescript
interface GenerationOptions {
  size?: string
  sequentialImageGeneration?: 'auto' | 'disabled'
  sequentialImageGenerationOptions?: {
    maxImages?: number
  }
  optimizePromptOptions?: {
    mode?: 'standard' | 'fast'
  }
  watermark?: boolean
}
```

### 计费流程
1. **创建任务时**：根据 `expectedImageCount` 预扣费
2. **生成完成后**：记录 `actualImageCount`
3. **自动退款**：`(expected - actual) × pricePerImage`

---

## 📊 监控和日志

### 关键指标
- 预期 vs 实际图片数量差异
- 退款率（退款金额 / 预付费金额）
- 组图模式的平均实际生成数量

### 日志示例
```
[Task] Creating task: 10 batches, expected 80 images (10/image) = 800 total
[Task] Generated 45/10 images succeeded
[Task] Refunded 350 for task 123 (80 expected - 45 actual)
```

---

## ⚠️ 注意事项

1. **组图模式的不确定性**
   - 实际生成数量由 AI 决定，可能远小于预期
   - 建议向用户清晰说明计费规则

2. **预付费金额**
   - 组图模式下预付费可能较高
   - 确保用户余额充足

3. **退款延迟**
   - 退款在任务完成后自动处理
   - 通常在 1-2 分钟内到账

4. **兼容性**
   - 旧任务数据自动迁移
   - `expected_image_count` 默认等于 `image_number`

---

## 📝 更新日志

### v2.0.0 (2025-XX-XX)
- ✨ 新增图片尺寸选择（智能模式 + 固定尺寸）
- ✨ 新增组图模式（AI 智能生成关联图片）
- ✨ 新增提示词优化选项（标准/快速模式）
- ✨ 新增水印控制选项
- 🔄 重构计费逻辑（预付费 + 智能退款）
- 💾 新增数据库字段（generationOptions, expectedImageCount, actualImageCount）
- 📖 完善用户交互提示

